<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <meta name="description" content="" />
  <meta name="author" content="" />
  <title>UI for the On-Chain State Management zkApp</title>
  <style>
    table,
    form,
    th,
    td {
      border: 1px solid black;
      border-collapse: collapse
    }
  </style>

  <script type="module">
    import {
      Mina,
      PrivateKey,
      AccountUpdate,
      Field,
      isReady,
      SmartContract,
      state,
      State,
      method,
      Permissions
    } from './index.js'
    import {
      HelloWorld,
      adminPrivateKey
    } from './examples/zkapps/hello_world/hello_world.js'
    import { logEvents } from './e2eTestsHelpers.js'

    await isReady

    const deployButton = document.querySelector('#deployButton')
    const updateButton = document.querySelector('#updateButton')
    const eventsContainer = document.querySelector('#eventsContainer')
    const zkAppStateContainer = document.querySelector('#zkAppStateContainer')

    logEvents(
      `SnarkyJS initialized after ${performance.now().toFixed(2)}ms`,
      eventsContainer
    )

    // Setup local ledger
    let Local = Mina.LocalBlockchain()
    Mina.setActiveInstance(Local)
    // Test account that pays all the fees
    const feePayer = Local.testAccounts[0].privateKey
    // zkApp account
    const zkAppPrivateKey = PrivateKey.random()
    const zkAppAddress = zkAppPrivateKey.toPublicKey()
    const zkAppInstance = new HelloWorld(zkAppAddress)

    deployButton.addEventListener('click', async () => {
      deployButton.disabled = true

      logEvents('Deploying zkApp...', eventsContainer)

      try {
        const { verificationKey } = await HelloWorld.compile(zkAppAddress)
        const deploymentTransaction = await Mina.transaction(feePayer, () => {
          AccountUpdate.fundNewAccount(feePayer)
          zkAppInstance.deploy({
            verificationKey,
            zkappKey: zkAppPrivateKey
          })
        })

        await deploymentTransaction.send()
        const initialState = Mina.getAccount(zkAppAddress).appState?.[0].toString()
        zkAppStateContainer.innerHTML = initialState
        logEvents(`Initial zkApp State: ${initialState}`, eventsContainer)
        logEvents('zkApp Deployed successfully!', eventsContainer)
      } catch (exception) {
        logEvents(`zkApp Deployment failure: ${exception.message}`, eventsContainer)
        console.log(exception)
      }

      deployButton.disabled = false
    })

    updateButton.addEventListener('click', async (event) => {
      event.preventDefault()
      updateButton.disabled = true

      const formData = JSON.stringify(
        Object.fromEntries(new FormData(document.querySelector('#zkAppUpdateForm'))),
      )
      const zkAppStateValue = document.querySelector('#zkAppStateValue')

      try {
        const currentState = Mina.getAccount(zkAppAddress).appState?.[0].toString()
        logEvents(
          `Updating zkApp State from ${currentState} to ${zkAppStateValue.value} with Admin Private Key and using form data: ${formData}...`,
          eventsContainer
        )
        const transaction = await Mina.transaction(feePayer, () => {
          zkAppInstance.update(Field(parseInt(zkAppStateValue.value)), adminPrivateKey)
          zkAppInstance.sign(zkAppPrivateKey)
        })

        await transaction.prove()
        await transaction.send()

        const newState = Mina.getAccount(zkAppAddress).appState?.[0].toString()
        zkAppStateContainer.innerHTML = newState
        logEvents(`zkApp State successfully updated to: ${newState}!`, eventsContainer)
      } catch (exception) {
        logEvents(`zkApp State Update failure: ${exception.message}`, eventsContainer)
        console.log(exception)
      }

      updateButton.disabled = false
      return false
    })
  </script>
</head>

<body>
  <div>
    <div>
      <h3>UI for the On-Chain State Management zkApp</h3>
    </div>
    <hr />
    <div>
      <h4>zkApp Management</h4>
      <div>
        <button type="button" id="deployButton">Deploy zkApp</button>
        <hr />
        <form style="width: 50%" action="" method="POST" id="zkAppUpdateForm">
          <div>
            <label for="zkAppStateValue"><u>zkApp State</u>:</label>
            <input type="number" id="zkAppStateValue" name="zkAppStateValue" placeholder="Enter new zkApp state"
              value="" required />
          </div>
          <br />
          <button type="submit" id="updateButton">Update zkApp State</button>
        </form>
      </div>
    </div>
    <hr />
    <div>
      <h4>Application Data</h4>
      <table>
        <caption></caption>
        <tr>
          <th scope="col"></th>
          <th scope="col"></th>
        </tr>
        <tbody>
          <tr>
            <td style="width: 20%">
              <span>zkAppState[0]</span>:
            </td>
            <td>
              <span id="zkAppStateContainer">No data available yet.</span>
            </td>
          </tr>
          <tr>
            <td style="width: 20%">
              <span>Events</span>:
            </td>
            <td>
              <span id="eventsContainer">No data available yet.</span>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</body>

</html>